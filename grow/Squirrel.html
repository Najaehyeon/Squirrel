<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‹¤ëŒì¥ì˜ ë„í† ë¦¬ ëª©ì¥</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(to bottom, #aed6f1, #f0f8ff);
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        color: #333;
      }
      #game-container {
        max-width: 900px;
        width: 95%;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden; /* ë¯¸ë‹ˆê²Œì„ ë„í† ë¦¬ê°€ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
      }
      #start-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(to bottom, #aed6f1, #f0f8ff);
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1001; /* ê²Œì„ ì»¨í…Œì´ë„ˆë³´ë‹¤ ìœ„ì— */
      }
      #start-screen h1 {
        font-size: 3em;
        color: #588e2c;
        margin-bottom: 30px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }
      #start-button {
        padding: 15px 30px;
        font-size: 1.5em;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease, transform 0.2s ease;
      }
      #start-button:hover {
        background-color: #45a049;
        transform: translateY(-3px);
      }
      #start-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      h1 {
        text-align: center;
        color: #588e2c;
        margin-bottom: 20px;
        font-size: 2.2em;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      #status {
        display: flex;
        justify-content: space-around;
        background: #e6ffe6;
        padding: 10px 0;
        border-radius: 10px;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: bold;
        color: #38761d;
        border: 1px solid #c8e6c9;
      }
      #status div {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #trees-container {
        background: #d4f7b4;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #b2df95;
      }
      #trees {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
      }
      .tree {
        background: #90ee90;
        border: 3px solid #3cb371;
        border-radius: 10px;
        padding: 15px 10px;
        text-align: center;
        font-weight: bold;
        color: #2e8b57;
        cursor: pointer;
        transition: transform 0.1s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .tree:hover {
        transform: translateY(-3px);
      }
      .tree.selected {
        border-color: #ff4500;
        box-shadow: 0 0 0 3px #ff4500;
      }
      #items-container,
      #minigame-input-container {
        /* í™œë™ì¹¸ì´ ì‚¬ë¼ì§€ë©´ì„œ #actions-container ì œê±° */
        background: #ffe0b2;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #ffcc80;
      }
      h2 {
        color: #e65100;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.5em;
        text-align: center;
      }
      #items button {
        /* #actions button ìŠ¤íƒ€ì¼ ì œê±° */
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s, transform 0.1s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative; /* íˆ´íŒì„ ìœ„í•œ relative */
      }
      #items button .tooltip {
        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        visibility: hidden;
        width: 200px;
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%; /* ë²„íŠ¼ ìœ„ë¡œ */
        left: 50%;
        margin-left: -100px; /* ì¤‘ì•™ ì •ë ¬ */
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8em;
        line-height: 1.4;
      }
      #items button .tooltip::after {
        /* íˆ´íŒ ê¼¬ë¦¬ */
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
      }
      #items button:hover .tooltip {
        /* í˜¸ë²„ ì‹œ íˆ´íŒ ë³´ì´ê¸° */
        visibility: visible;
        opacity: 1;
      }

      #items button {
        background: #81c784;
        color: white;
      }
      #items button:hover:not(:disabled) {
        background: #66bb6a;
        transform: translateY(-2px);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #cccccc !important;
      }
      #log-container {
        background: #e0f2f7;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #b3e5fc;
      }
      #log {
        height: 150px;
        overflow-y: auto;
        background: #f0faff;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.95em;
        line-height: 1.6;
        border: 1px solid #c0e6f7;
      }
      .log-message {
        margin-bottom: 5px;
      }
      .log-important {
        font-weight: bold;
        color: #d32f2f;
      }
      .log-success {
        color: #388e3c;
      }
      /* Popup styles */
      #popup-overlay,
      #game-over-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      #event-popup,
      #game-over-popup {
        background: #fff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
        width: 90%;
        color: #333;
      }
      #event-popup h3,
      #game-over-popup h3 {
        color: #e65100;
        margin-top: 0;
        font-size: 1.8em;
      }
      #game-over-popup h3 {
        color: #f44336;
        font-size: 2em;
      }
      #event-popup p,
      #game-over-popup p {
        margin-bottom: 20px;
        font-size: 1.1em;
        line-height: 1.6;
      }
      #game-over-popup p {
        margin-bottom: 25px;
        font-size: 1.2em;
      }
      #event-popup .button-group button,
      #game-over-popup button {
        background: #4caf50;
        color: white;
        padding: 12px 25px;
        margin: 8px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        transition: background-color 0.2s, transform 0.1s;
      }
      #event-popup .button-group button:hover:not(:disabled) {
        background: #388e3c;
        transform: translateY(-2px);
      }
      #event-popup .button-group button.danger {
        background: #f44336;
      }
      #event-popup .button-group button.danger:hover:not(:disabled) {
        background: #d32f2f;
      }
      #game-over-popup button {
        background: #2196f3;
      }
      #game-over-popup button:hover {
        background: #1976d2;
      }

      /* Mini-game specific styles */
      #mini-game-area {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: calc(100% - 150px); /* ì…ë ¥ì°½ ì•„ë˜ê¹Œì§€ */
        pointer-events: none; /* ê¸°ë³¸ì ìœ¼ë¡œ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ í†µê³¼ì‹œí‚´ */
        z-index: 1; /* ë‹¤ë¥¸ UI ìš”ì†Œ ë’¤ì— ìœ„ì¹˜ */
      }
      .falling-acorn {
        position: absolute;
        width: 60px; /* ë„í† ë¦¬ í¬ê¸° í‚¤ì›€ */
        height: 60px;
        background-color: #8b4513; /* ë„í† ë¦¬ ìƒ‰ìƒ */
        border-radius: 50% 50% 30% 30% / 50% 50% 70% 70%; /* ë„í† ë¦¬ ëª¨ì–‘ */
        box-shadow: inset -3px -3px 5px rgba(0, 0, 0, 0.3);
        cursor: default; /* í´ë¦­ ì»¤ì„œ ì—†ì•° */
        pointer-events: auto; /* í´ë¦­ ê°€ëŠ¥í•˜ê²Œ í•¨ */
        z-index: 2; /* ë„í† ë¦¬ íŒì—…ë³´ë‹¤ ì•ì— */
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
        font-size: 0.8em; /* ë‹¨ì–´ ê¸€ì í¬ê¸° */
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      .falling-acorn.hit {
        /* ë§ì¶˜ ë„í† ë¦¬ íš¨ê³¼ */
        background-color: #4caf50;
        transition: all 0.2s ease-out;
        opacity: 0;
        transform: scale(1.5);
      }
      #minigame-input-container {
        padding-top: 0; /* ìƒë‹¨ íŒ¨ë”© ì œê±° */
      }
      #typing-input-area {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #typing-input-area p {
        margin-bottom: 10px;
        font-weight: bold;
        color: #e65100;
      }
      #typing-input {
        width: 80%;
        padding: 10px;
        font-size: 1.2em;
        border: 2px solid #ffcc80;
        border-radius: 8px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="start-screen">
      <h1>ğŸ¿ï¸ ë‹¤ëŒì¥ì˜ ë„í† ë¦¬ ëª©ì¥ ğŸŒ³</h1>
      <button id="start-button">ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="game-container">
      <h1>ğŸ¿ï¸ ë‹¤ëŒì¥ì˜ ë„í† ë¦¬ ëª©ì¥ ğŸŒ³</h1>
      <div id="status">
        <div>ì¼ì°¨: <span id="day">1</span>/100</div>
        <div>ë„í† ë¦¬: <span id="acorns">0</span></div>
        <div>ì‹œê°„: <span id="timer">60</span>s</div>
      </div>

      <div id="trees-container">
        <h2>ë‚´ ë„í† ë¦¬ ë‚˜ë¬´ë“¤</h2>
        <div id="trees"></div>
      </div>

      <div id="items-container">
        <h2>ë‚´ ì•„ì´í…œ ê°€ë°©</h2>
        <div id="items"></div>
      </div>

      <div id="minigame-input-container">
        <h2>ë„í† ë¦¬ ìºì¹˜! âŒ¨ï¸</h2>
        <div id="typing-input-area">
          <p>ë„í† ë¦¬ì— ì íŒ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”!</p>
          <input
            type="text"
            id="typing-input"
            placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..."
          />
        </div>
      </div>

      <div id="log-container">
        <h2>í™œë™ ë¡œê·¸</h2>
        <div id="log"></div>
      </div>

      <div id="mini-game-area"></div>
    </div>

    <div id="popup-overlay" style="display: none">
      <div id="event-popup">
        <h3 id="event-title"></h3>
        <p id="event-message"></p>
        <div id="event-options" class="button-group"></div>
      </div>
    </div>

    <div id="game-over-overlay" style="display: none">
      <div id="game-over-popup">
        <h3>ê²Œì„ ì˜¤ë²„! ğŸ˜±</h3>
        <p id="game-over-message"></p>
        <button onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
      </div>
    </div>

    <script>
      const MAX_TREES = 8;
      let day = 1;
      let acorns = 0;
      let timer = 60;
      let trees = [];
      let festivalActive = false;
      let probabilityUpgradeCount = 0; // 'í–‡ì‚´ í•œ ìŠ¤í‘¼' ì‚¬ìš© íšŸìˆ˜
      let isGamePaused = true; // ê²Œì„ ì¼ì‹œì •ì§€ ìƒíƒœ (ì‹œì‘ ì „ì—ëŠ” true)

      const allPossibleItems = [
        "ë©§ë¼ì§€ í‡´ì¹˜ìš© í˜¸ë£¨ë¼ê¸°",
        "í•˜ëŠ˜ì˜ ë°©íŒ¨ ê·¸ë¬¼",
        "ë°˜ì§ì´ëŠ” í—ˆìˆ˜ì•„ë¹„",
        "ë±€ ë¬¼ë¦¬ì¹˜ëŠ” í’€",
        "íŠ¼íŠ¼í•œ ë°©ìˆ˜í¬",
        "ë¹„ë£Œ í¬ëŒ€",
        "ë„í† ë¦¬ ì”¨ì•—",
        "í–‡ì‚´ í•œ ìŠ¤í‘¼",
        "ê²°í•©ì˜ ë¬˜ëª© ì‚½", // ìƒˆë¡œìš´ ì•„ì´í…œ ì¶”ê°€
        "ë¹›ë‚˜ëŠ” ì€í™”", // ê±°ë˜ ì•„ì´í…œ
        "ê³ ê¸‰ ë¹„ë‹¨ ì¡°ê°", // ê±°ë˜ ì•„ì´í…œ
        "ë§ˆë ¥ì´ ê¹ƒë“  ìˆ˜ì •", // ê±°ë˜ ì•„ì´í…œ
      ];

      // ì•„ì´í…œ ì„¤ëª… ê°ì²´
      const itemDescriptions = {
        "ë©§ë¼ì§€ í‡´ì¹˜ìš© í˜¸ë£¨ë¼ê¸°":
          "ë©§ë¼ì§€ ìŠµê²© ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‚¬ìš©í•˜ì—¬ ë„í† ë¦¬ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤.",
        "í•˜ëŠ˜ì˜ ë°©íŒ¨ ê·¸ë¬¼":
          "ë…ìˆ˜ë¦¬ ìŠµê²© ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‚¬ìš©í•˜ì—¬ ë„í† ë¦¬ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤.",
        "ë°˜ì§ì´ëŠ” í—ˆìˆ˜ì•„ë¹„":
          "ìƒˆë–¼ ìŠµê²© ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‚¬ìš©í•˜ì—¬ ë„í† ë¦¬ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤.",
        "ë±€ ë¬¼ë¦¬ì¹˜ëŠ” í’€":
          "ë…ì‚¬ ì¹¨ì… ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‚¬ìš©í•˜ì—¬ ë„í† ë¦¬ ì†ì‹¤ì„ ë§‰ìŠµë‹ˆë‹¤.",
        "íŠ¼íŠ¼í•œ ë°©ìˆ˜í¬": "í­ìš° ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‚¬ìš©í•˜ì—¬ ë„í† ë¦¬ ì†ì‹¤ì„ ë§‰ìŠµë‹ˆë‹¤.",
        "ë¹„ë£Œ í¬ëŒ€":
          "ë„í† ë¦¬ ë‚˜ë¬´ë¥¼ ì„ íƒí•˜ì—¬ ì£¼ë©´ í•´ë‹¹ ë‚˜ë¬´ì˜ ë„í† ë¦¬ ìƒì‚°ëŸ‰ì´ 2ë°° ì¦ê°€í•©ë‹ˆë‹¤.",
        "ë„í† ë¦¬ ì”¨ì•—": "ìƒˆë¡œìš´ ë„í† ë¦¬ ë‚˜ë¬´ í•œ ê·¸ë£¨ë¥¼ ì‹¬ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "í–‡ì‚´ í•œ ìŠ¤í‘¼":
          "ëª¨ë“  ë„í† ë¦¬ ë‚˜ë¬´ì˜ ë„í† ë¦¬ ìƒì‚° í™•ë¥ ì„ 5% ì¦ê°€ì‹œí‚µë‹ˆë‹¤. (ìµœëŒ€ 10íšŒ ì‚¬ìš© ê°€ëŠ¥)",
        "ê²°í•©ì˜ ë¬˜ëª© ì‚½":
          "ë‘ ê·¸ë£¨ì˜ ë„í† ë¦¬ ë‚˜ë¬´ë¥¼ í•©ì³ ë” ê°•ë ¥í•œ í•œ ê·¸ë£¨ì˜ ë‚˜ë¬´ë¡œ ë§Œë“­ë‹ˆë‹¤. (ìƒì‚°ëŸ‰ê³¼ ë ˆë²¨ í•©ì‚°)",
        "ë¹›ë‚˜ëŠ” ì€í™”": "ë…¸ì¸ê³¼ì˜ íŠ¹ë³„í•œ ê±°ë˜ì— ì‚¬ìš©ë˜ëŠ” ì‹ ë¹„í•œ ì€í™”ì…ë‹ˆë‹¤.",
        "ê³ ê¸‰ ë¹„ë‹¨ ì¡°ê°":
          "ì—¬ìš° ìƒì¸ê³¼ì˜ íŠ¹ë³„í•œ ê±°ë˜ì— ì‚¬ìš©ë˜ëŠ” ì•„ë¦„ë‹¤ìš´ ë¹„ë‹¨ ì¡°ê°ì…ë‹ˆë‹¤.",
        "ë§ˆë ¥ì´ ê¹ƒë“  ìˆ˜ì •":
          "ë§ˆë…€ì™€ì˜ íŠ¹ë³„í•œ ê±°ë˜ì— ì‚¬ìš©ë˜ëŠ” ê°•ë ¥í•œ ìˆ˜ì •ì…ë‹ˆë‹¤.",
      };

      const inventory = {
        "ë©§ë¼ì§€ í‡´ì¹˜ìš© í˜¸ë£¨ë¼ê¸°": 0,
        "í•˜ëŠ˜ì˜ ë°©íŒ¨ ê·¸ë¬¼": 0,
        "ë°˜ì§ì´ëŠ” í—ˆìˆ˜ì•„ë¹„": 0,
        "ë±€ ë¬¼ë¦¬ì¹˜ëŠ” í’€": 0,
        "íŠ¼íŠ¼í•œ ë°©ìˆ˜í¬": 0,
        "ë¹„ë£Œ í¬ëŒ€": 0,
        "ë„í† ë¦¬ ì”¨ì•—": 0,
        "í–‡ì‚´ í•œ ìŠ¤í‘¼": 0,
        "ê²°í•©ì˜ ë¬˜ëª© ì‚½": 0,
        "ë¹›ë‚˜ëŠ” ì€í™”": 0,
        "ê³ ê¸‰ ë¹„ë‹¨ ì¡°ê°": 0,
        "ë§ˆë ¥ì´ ê¹ƒë“  ìˆ˜ì •": 0,
      };

      // ì´ë²¤íŠ¸ ì •ì˜ (ê¸°íšì— ë§ì¶° ìƒì„¸ ìˆ˜ì •)
      const eventList = [
        {
          type: "disaster",
          name: "ë©§ë¼ì§€ì˜ í˜‘ë°•",
          message: "ì‚¬ë‚˜ìš´ ë©§ë¼ì§€ê°€ ë„í† ë¦¬ë¥¼ ìš”êµ¬í•©ë‹ˆë‹¤!",
          baseCost: 20, // ê¸°ë³¸ ë¹„ìš©
          defenseItem: "ë©§ë¼ì§€ í‡´ì¹˜ìš© í˜¸ë£¨ë¼ê¸°",
          rewards: ["ë¹„ë£Œ í¬ëŒ€", "ë„í† ë¦¬ ì”¨ì•—", "í–‡ì‚´ í•œ ìŠ¤í‘¼"],
        },
        {
          type: "disaster",
          name: "ë…ìˆ˜ë¦¬ì˜ ìŠµê²©",
          message: "ê±°ëŒ€í•œ ë…ìˆ˜ë¦¬ê°€ ë„í† ë¦¬ ëª©ì¥ì„ ë…¸ë¦½ë‹ˆë‹¤!",
          baseCost: 30,
          defenseItem: "í•˜ëŠ˜ì˜ ë°©íŒ¨ ê·¸ë¬¼",
          rewards: ["ê²°í•©ì˜ ë¬˜ëª© ì‚½", "ë„í† ë¦¬ ì”¨ì•—", "íŠ¼íŠ¼í•œ ë°©ìˆ˜í¬"],
        },
        {
          type: "disaster",
          name: "ìƒˆë–¼ ìŠµê²©",
          message: "ìˆ˜ë§ì€ ìƒˆë–¼ê°€ ë„í† ë¦¬ë¥¼ ìª¼ì•„ë¨¹ìœ¼ë ¤ í•©ë‹ˆë‹¤!",
          baseCost: 15,
          defenseItem: "ë°˜ì§ì´ëŠ” í—ˆìˆ˜ì•„ë¹„",
          rewards: ["ë±€ ë¬¼ë¦¬ì¹˜ëŠ” í’€", "ë¹„ë£Œ í¬ëŒ€", "í–‡ì‚´ í•œ ìŠ¤í‘¼"],
        },
        {
          type: "threat",
          name: "ë…ì‚¬ ì¹¨ì…",
          message: "ë…ì‚¬ê°€ ë°©ê³µí˜¸ì— ì¹¨ì…í–ˆìŠµë‹ˆë‹¤! ë„í† ë¦¬ê°€ ì˜¤ì—¼ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
          baseLossRate: 0.3, // ê¸°ë³¸ ì†ì‹¤ë¥ 
          defenseItem: "ë±€ ë¬¼ë¦¬ì¹˜ëŠ” í’€",
        },
        {
          type: "threat",
          name: "í­ìš°",
          message: "ê°‘ì‘ìŠ¤ëŸ¬ìš´ í­ìš°ê°€ ëª©ì¥ì˜ ë„í† ë¦¬ë“¤ì„ íœ©ì“¸ë ¤ í•©ë‹ˆë‹¤!",
          baseLossRate: 0.3,
          defenseItem: "íŠ¼íŠ¼í•œ ë°©ìˆ˜í¬",
        },
        {
          type: "opportunity",
          name: "ì •ì²´ë¶ˆëª…ì˜ ë…¸ì¸",
          message: "ë‚¡ì€ ì˜·ì„ ì…ì€ ë…¸ì¸ì´ ë‹¹ì‹ ì—ê²Œ ê±°ë˜ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.",
          costType: "acorns",
          baseCost: 10,
          specialItem: "ë¹›ë‚˜ëŠ” ì€í™”",
          specialItemCost: 1,
          rewards: [
            "ë„í† ë¦¬ ì”¨ì•—",
            "ë¹„ë£Œ í¬ëŒ€",
            "ê²°í•©ì˜ ë¬˜ëª© ì‚½",
            "í–‡ì‚´ í•œ ìŠ¤í‘¼",
          ],
        },
        {
          type: "opportunity",
          name: "ì—¬ìš° ìƒì¸",
          message: "ëŠ¥ê¸€ë§ì€ ì—¬ìš° ìƒì¸ì´ ë‹¹ì‹ ì˜ ë¬¼ê±´ì— ê´€ì‹¬ì„ ë³´ì…ë‹ˆë‹¤.",
          costType: "acorns",
          baseCost: 15,
          specialItem: "ê³ ê¸‰ ë¹„ë‹¨ ì¡°ê°",
          specialItemCost: 1,
          rewards: [
            "í•˜ëŠ˜ì˜ ë°©íŒ¨ ê·¸ë¬¼",
            "ë©§ë¼ì§€ í‡´ì¹˜ìš© í˜¸ë£¨ë¼ê¸°",
            "ë°˜ì§ì´ëŠ” í—ˆìˆ˜ì•„ë¹„",
            "ë„í† ë¦¬ ì”¨ì•—",
          ],
        },
        {
          type: "opportunity",
          name: "ë§ˆë…€ì˜ ê±°ë˜",
          message: "ì‹ ë¹„ë¡œìš´ ë§ˆë…€ê°€ ë‹¹ì‹ ì—ê²Œ ê°•ë ¥í•œ ê±°ë˜ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.",
          costType: "acorns",
          baseCost: 25,
          specialItem: "ë§ˆë ¥ì´ ê¹ƒë“  ìˆ˜ì •",
          specialItemCost: 1,
          rewards: [
            "ëª¨ë“  ë°©ì–´ ì•„ì´í…œ ì¤‘ 1ê°œ",
            "ê²°í•©ì˜ ë¬˜ëª© ì‚½",
            "í–‡ì‚´ í•œ ìŠ¤í‘¼",
          ], // ë³´ìƒ ì¡°ì •
        },
        {
          type: "bonus",
          name: "ìˆ² ì¶•ì œ",
          message: "ìˆ²ì˜ ìš”ì •ë“¤ì´ ì¶•ë³µì„ ë‚´ë¦½ë‹ˆë‹¤!",
        },
      ];

      // íƒ€ì ë¯¸ë‹ˆê²Œì„ ë‹¨ì–´ ëª©ë¡ (ì§§ê³  ê°„ë‹¨í•œ ë‹¨ì–´ ìœ„ì£¼)
      const typingWords = [
        "ë‚˜ë¬´",
        "ë„í† ë¦¬",
        "ìˆ²",
        "ë‹¤ëŒì¥",
        "í–‰ë³µ",
        "ì—´ë§¤",
        "í–‡ì‚´",
        "ë°”ëŒ",
        "ë°¤",
        "ë•…",
        "ììœ ",
        "ì†Œë¦¬",
        "ê¿ˆ",
        "ì§‘",
        "ì¹œêµ¬",
        "ì›ƒìŒ",
        "í¬ë§",
        "ì„±ì¥",
        "ê°•",
        "ì‚°",
        "í•˜ëŠ˜",
        "ë³„",
        "ë‹¬",
        "ë¬¼",
        "ì”¨ì•—",
        // 3ê¸€ì ë‹¨ì–´ ì¶”ê°€
        "ì‚¬ê³¼",
        "ë°”ë‚˜ë‚˜",
        "í¬ë„",
        "ì˜¤ë Œì§€",
        "ë”¸ê¸°",
        "ìˆ˜ë°•",
        "ë©œë¡ ",
        "ë³µìˆ­ì•„",
        "ì¥ë¯¸",
        "êµ­í™”",
        "í•´ë°”ë¼ê¸°",
        "íŠ¤ë¦½",
        "ê°œë‚˜ë¦¬",
        "ì§„ë‹¬ë˜",
        "ë²šê½ƒ",
        "ë‚˜ë¹„",
        "ë²Œ",
        "ì ìë¦¬",
        "ê°œë¯¸",
        "ë¬´ë‹¹ë²Œë ˆ",
        "ê±°ë¯¸",
        "ì§€ë ì´",
        "ë³‘ì•„ë¦¬",
        "ê°•ì•„ì§€",
        "ê³ ì–‘ì´",
        "ì†¡ì•„ì§€",
        "ë§ì•„ì§€",
        "ë³‘ì•„ë¦¬",
        "ì˜¤ë¦¬",
        "ë‹­",
        "ìƒˆ",
        "ë¬¼ê³ ê¸°",
        "ì‚¬ìŠ´",
        "ê³°",
        "í˜¸ë‘ì´",
        "ì½”ë¼ë¦¬",
        "ê¸°ë¦°",
        "ì›ìˆ­ì´",
        "ë‚™íƒ€",
        "í­ê·„",
        "ë°”ë‹¤",
        "êµ¬ë¦„",
        "ì´ìŠ¬",
        "ì•ˆê°œ",
        "í–‡ë¹›",
        "ë‹¬ë¹›",
        "ëˆˆ",
        "ë¹„",
        "ë¬´ì§€ê°œ",
        "ë²ˆê°œ",
        "ì²œë‘¥",
        "í­í’",
        "í•´ì¼",
        "í™”ì‚°",
        "ì§€ì§„",
        "íŒŒë„",
        "ëª¨ë˜",
        "ëŒ",
        "í™",
        "ë°”ìœ„",
        "ê³„ê³¡",
        "ì ˆë²½",
        "ì´ˆì›",
        "ì‚¬ë§‰",
        "ì—°ëª»",
        "í˜¸ìˆ˜",
        "ì„¬",
        "ë“±ëŒ€",
        "í•­êµ¬",
        "ë±ƒë†€ì´",
        "ìš”ì •",
        "ë§ˆë²•",
        "ìš©ê¸°",
        "ì§€í˜œ",
        "ì‚¬ë‘",
        "ìš°ì •",
        "ì„±ì‹¤",
        "ì •ì§",
        "ì¹œì ˆ",
        "ìš©ì„œ",
        "ì¶•ë³µ",
        "ì„ ë¬¼",
        "ë³´ë¬¼",
        "ê¸°ì ",
        "í–‰ìš´",
        "ê±´ê°•",
        "í‰í™”",
        "ì¬ë¬¼",
        "ìˆ˜í™•",
        "ë†ë¶€",
        "ë†ì¥",
        "ê³¡ì‹",
        "ì—´ë§¤",
        "ì±„ì†Œ",
        "ê³¼ì¼",
        "ê°€ë­„",
        "í™ìˆ˜",
        "ì§ˆë³‘",
        "ì „ì—¼ë³‘",
        "ì „ìŸ",
        "í‰í™”",
        "ì¬ì•™",
        "ì¶•ë³µ",
        "íƒ„ìƒ",
        "ì£½ìŒ",
        "ì‚¶",
        "ì‹œê°„",
        "ê³µê°„",
        "í–‰ì„±",
        "ìš°ì£¼",
        "ì€í•˜",
        "íƒœì–‘",
        "í–‰ì„±",
        "í˜œì„±",
        "ìœ ì„±",
        "ê´‘ì„ ",
        "ë¯¸ë˜",
        "ê³¼ê±°",
        "í˜„ì¬",
        "ì˜ì›",
        "ê³„ì ˆ",
        "ë´„",
        "ì—¬ë¦„",
        "ê°€ì„",
        "ê²¨ìš¸",
        "ìƒˆë²½",
        "ì•„ì¹¨",
        "ì ì‹¬",
        "ì €ë…",
        "ë°¤",
        "ì˜¤ëŠ˜",
        "ë‚´ì¼",
        "ì–´ì œ",
        "í•˜ë£¨",
        "ì¼ë…„",
        "ë°±ë…„",
        "ê°€ì¡±",
        "ë¶€ëª¨",
        "í˜•ì œ",
        "ìë§¤",
        "ì¹œêµ¬",
        "ì´ì›ƒ",
        "ë™ë£Œ",
        "ì„ ìƒ",
        "í•™ìƒ",
        "ì–´ë¥¸",
        "ì•„ì´",
        "ë‚¨ì",
        "ì—¬ì",
        "ì‚¬ëŒ",
        "ì¸ìƒ",
        "ìš´ëª…",
        "ë„ì „",
        "ì„±ê³µ",
        "ì‹¤íŒ¨",
        "ìš©ì„œ",
        "ê¸°íšŒ",
        "ë³€í™”",
        "ì„±ì¥",
        "ë°œì „",
      ];

      const startScreen = document.getElementById("start-screen");
      const startButton = document.getElementById("start-button");
      const gameContainer = document.getElementById("game-container");

      const container = document.getElementById("trees");
      const acornSpan = document.getElementById("acorns");
      const daySpan = document.getElementById("day");
      const timerSpan = document.getElementById("timer");
      const logBox = document.getElementById("log");
      const itemsDiv = document.getElementById("items");
      // const nextDayBtn = document.getElementById("next-day-btn"); // 'ë°¤ìœ¼ë¡œ ë„˜ì–´ê°€ê¸°' ë²„íŠ¼ ì œê±°

      const popupOverlay = document.getElementById("popup-overlay");
      const eventPopup = document.getElementById("event-popup");
      const eventTitle = document.getElementById("event-title");
      const eventMessage = document.getElementById("event-message");
      const eventOptions = document.getElementById("event-options");

      const gameOverOverlay = document.getElementById("game-over-overlay");
      const gameOverPopup = document.getElementById("game-over-popup");
      const gameOverMessage = document.getElementById("game-over-message");

      const miniGameArea = document.getElementById("mini-game-area"); // ë¯¸ë‹ˆê²Œì„ ì˜ì—­
      const typingInput = document.getElementById("typing-input"); // íƒ€ì ì…ë ¥ì°½

      let gameInterval = null; // ì´ˆê¸°ê°’ì„ nullë¡œ ì„¤ì •í•˜ì—¬ ì¤‘ë³µ ìƒì„± ë°©ì§€
      let selectedTrees = []; // ë‚˜ë¬´ í•©ì¹˜ê¸° ê¸°ëŠ¥ìš©
      let currentSelectedMode = null; // null, 'fertilizer', 'combine'

      let miniGameAcornInterval = null; // ë¯¸ë‹ˆê²Œì„ ë„í† ë¦¬ ìƒì„± ì¸í„°ë²Œ
      let fallingAcorns = []; // ë–¨ì–´ì§€ëŠ” ë„í† ë¦¬ ìš”ì†Œë“¤ (ê°ì²´ë¡œ ê´€ë¦¬)
      let animationFrameId = null; // requestAnimationFrame ID (ë¯¸ë‹ˆê²Œì„ ì• ë‹ˆë©”ì´ì…˜)

      function log(msg, type = "") {
        const div = document.createElement("div");
        div.className = `log-message ${type}`;
        div.textContent = `[${day}ì¼ì°¨] ${msg}`;
        logBox.prepend(div); // ìµœì‹  ë¡œê·¸ê°€ ìœ„ì— ì˜¤ë„ë¡
        if (logBox.children.length > 20) {
          logBox.removeChild(logBox.lastChild); // ë„ˆë¬´ ë§ì•„ì§€ë©´ ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ
        }
      }

      class Tree {
        constructor(id, level = 1) {
          this.id = id; // ë‚˜ë¬´ ì‹ë³„ì
          this.level = level; // ë‚˜ë¬´ ë ˆë²¨
          this.productionPerTick = level; // 1í‹±(ì´ˆ)ë‹¹ ìƒì‚°ëŸ‰
          this.productionProbability = 0.5; // ìƒì‚° í™•ë¥  (0.5 = 50%)
          this.element = document.createElement("div");
          this.element.className = "tree";
          this.element.dataset.id = id;
          this.element.onclick = () => selectTree(this.id);
          this.updateDisplay();
        }

        updateDisplay() {
          this.element.textContent = `ë ˆë²¨ ${this.level}\në„í† ë¦¬ +${
            this.productionPerTick
          }\ní™•ë¥ : ${Math.floor(this.productionProbability * 100)}%`;
        }

        attemptProduction() {
          let actualProd = this.productionPerTick;
          if (festivalActive) {
            actualProd *= 2; // ì¶•ì œ íš¨ê³¼ ì ìš©
          }
          if (Math.random() < this.productionProbability) {
            acorns += actualProd;
          }
        }
      }

      function plantNewTree() {
        if (trees.length >= MAX_TREES) {
          log("ë” ì´ìƒ ë‚˜ë¬´ë¥¼ ì‹¬ì„ ê³µê°„ì´ ì—†ìŠµë‹ˆë‹¤!", "log-important");
          return false;
        }
        const newTreeId =
          trees.length > 0 ? Math.max(...trees.map((t) => t.id)) + 1 : 0;
        const newTree = new Tree(newTreeId);
        trees.push(newTree);
        renderTrees();
        log("ìƒˆì‹¹ ë„í† ë¦¬ ë‚˜ë¬´ë¥¼ ì‹¬ì—ˆìŠµë‹ˆë‹¤! ğŸŒ±", "log-success");
        return true;
      }

      function renderTrees() {
        container.innerHTML = "";
        trees.forEach((tree) => {
          tree.updateDisplay();
          container.appendChild(tree.element);
        });
        updateUI();
      }

      function updateUI() {
        acornSpan.textContent = Math.floor(acorns);
        daySpan.textContent = day;
        renderInventory();
        // nextDayBtn.disabled = isGamePaused; // 'ë°¤ìœ¼ë¡œ ë„˜ì–´ê°€ê¸°' ë²„íŠ¼ ì œê±°
      }

      function renderInventory() {
        itemsDiv.innerHTML = "";
        for (const key in inventory) {
          const btn = document.createElement("button");
          btn.textContent = `${key} (${inventory[key]})`;

          // íˆ´íŒ ì¶”ê°€
          const tooltip = document.createElement("span");
          tooltip.classList.add("tooltip");
          tooltip.textContent = itemDescriptions[key] || "ì„¤ëª… ì—†ìŒ";
          btn.appendChild(tooltip);

          btn.disabled = inventory[key] <= 0;
          // í–‡ì‚´ í•œ ìŠ¤í‘¼ì€ ì‚¬ìš© íšŸìˆ˜ ì œí•œë„ ë°˜ì˜
          if (key === "í–‡ì‚´ í•œ ìŠ¤í‘¼" && probabilityUpgradeCount >= 10) {
            btn.disabled = true;
          }
          btn.onclick = () => useItem(key);
          itemsDiv.appendChild(btn);
        }
      }

      function useItem(item) {
        if (inventory[item] <= 0) {
          log(`'${item}'ì´(ê°€) ë¶€ì¡±í•©ë‹ˆë‹¤.`, "log-important");
          return;
        }

        switch (item) {
          case "ë¹„ë£Œ í¬ëŒ€":
            if (trees.length === 0) {
              log("ë¹„ë£Œë¥¼ ì¤„ ë‚˜ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.", "log-important");
              return;
            }
            log("ë¹„ë£Œë¥¼ ì¤„ ë‚˜ë¬´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (í´ë¦­)", "log-important");
            setSelectedMode("fertilizer");
            break;
          case "ë„í† ë¦¬ ì”¨ì•—":
            if (plantNewTree()) {
              inventory[item]--;
            }
            break;
          case "í–‡ì‚´ í•œ ìŠ¤í‘¼":
            if (probabilityUpgradeCount >= 10) {
              log("ìƒì‚° í™•ë¥ ì€ ë” ì´ìƒ ë†’ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", "log-important");
              return;
            }
            inventory[item]--;
            probabilityUpgradeCount++;
            trees.forEach(
              (t) =>
                (t.productionProbability = Math.min(
                  1,
                  t.productionProbability + 0.05
                ))
            );
            trees.forEach((t) => t.updateDisplay());
            log("ë‚˜ë¬´ ìƒì‚° í™•ë¥ ì´ 5% ì¦ê°€í–ˆìŠµë‹ˆë‹¤! â˜€ï¸", "log-success");
            break;
          case "ê²°í•©ì˜ ë¬˜ëª© ì‚½":
            if (trees.length < 2) {
              log(
                "ë‚˜ë¬´ í•©ì¹˜ê¸°ëŠ” ë‘ ê·¸ë£¨ ì´ìƒì˜ ë‚˜ë¬´ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
                "log-important"
              );
              return;
            }
            log("í•©ì¹  ë‚˜ë¬´ ë‘ ê·¸ë£¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (í´ë¦­)", "log-important");
            setSelectedMode("combine");
            break;
          default: // ë°©ì–´ ì•„ì´í…œ ë° ê±°ë˜ ì•„ì´í…œì€ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‚¬ìš©ë¨
            log(`'${item}'ì€(ëŠ”) ì§€ê¸ˆ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, "log-important");
            break;
        }
        updateUI();
      }

      function setSelectedMode(mode) {
        currentSelectedMode = mode;
        selectedTrees = [];
        trees.forEach((t) => t.element.classList.remove("selected")); // ê¸°ì¡´ ì„ íƒ í•´ì œ
        log(
          `[${
            mode === "fertilizer" ? "ë¹„ë£Œ ì£¼ê¸°" : "ë‚˜ë¬´ í•©ì¹˜ê¸°"
          }] ëª¨ë“œ í™œì„±í™”. ë‚˜ë¬´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.`
        );
      }

      function selectTree(treeId) {
        const treeElement = document.querySelector(
          `.tree[data-id="${treeId}"]`
        );
        const treeObj = trees.find((t) => t.id === treeId);

        if (!treeObj) return;

        if (currentSelectedMode === "fertilizer") {
          if (inventory["ë¹„ë£Œ í¬ëŒ€"] <= 0) {
            log("ë¹„ë£Œ í¬ëŒ€ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", "log-important");
            currentSelectedMode = null; // ëª¨ë“œ í•´ì œ
            return;
          }
          inventory["ë¹„ë£Œ í¬ëŒ€"]--;
          treeObj.productionPerTick *= 2;
          treeObj.updateDisplay();
          log(`ì„ íƒí•œ ë‚˜ë¬´ì˜ ìƒì‚°ëŸ‰ì´ 2ë°°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!`, "log-success");
          currentSelectedMode = null;
          treeElement.classList.remove("selected"); // ì„ íƒ í•´ì œ
        } else if (currentSelectedMode === "combine") {
          if (inventory["ê²°í•©ì˜ ë¬˜ëª© ì‚½"] <= 0) {
            log("ê²°í•©ì˜ ë¬˜ëª© ì‚½ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", "log-important");
            currentSelectedMode = null; // ëª¨ë“œ í•´ì œ
            return;
          }

          if (!selectedTrees.includes(treeId)) {
            if (selectedTrees.length < 2) {
              selectedTrees.push(treeId);
              treeElement.classList.add("selected");
              log(`${selectedTrees.length}ë²ˆì§¸ ë‚˜ë¬´ ì„ íƒ ì™„ë£Œ.`, "log-success");
            }

            if (selectedTrees.length === 2) {
              combineTrees();
              currentSelectedMode = null;
              selectedTrees = []; // ì„ íƒ ì´ˆê¸°í™”
            }
          } else {
            // ì´ë¯¸ ì„ íƒëœ ë‚˜ë¬´ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
            selectedTrees = selectedTrees.filter((id) => id !== treeId);
            treeElement.classList.remove("selected");
            log(`ë‚˜ë¬´ ì„ íƒ í•´ì œ.`, "log-important");
          }
        }
        updateUI();
      }

      function combineTrees() {
        if (selectedTrees.length !== 2) {
          log("ë‘ ê·¸ë£¨ì˜ ë‚˜ë¬´ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.", "log-important");
          return;
        }

        const [id1, id2] = selectedTrees;
        const tree1Index = trees.findIndex((t) => t.id === id1);
        const tree2Index = trees.findIndex((t) => t.id === id2);

        if (tree1Index === -1 || tree2Index === -1) {
          log("ì„ íƒëœ ë‚˜ë¬´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "log-important");
          return;
        }

        const tree1 = trees[tree1Index];
        const tree2 = trees[tree2Index];

        // ìƒˆë¡œìš´ ë‚˜ë¬´ ìƒì„± (ë ˆë²¨ê³¼ ìƒì‚°ëŸ‰ í•©ì‚°)
        const newTree = new Tree(
          Math.max(...trees.map((t) => t.id)) + 1, // ìƒˆë¡œìš´ ID ë¶€ì—¬
          tree1.level + tree2.level // ë ˆë²¨ í•©ì‚°
        );
        newTree.productionPerTick =
          tree1.productionPerTick + tree2.productionPerTick;
        newTree.productionProbability = Math.max(
          tree1.productionProbability,
          tree2.productionProbability
        ); // ë†’ì€ í™•ë¥  ì ìš© (ì„ íƒ ì‚¬í•­)

        // í•©ì³ì§„ ë‚˜ë¬´ ì œê±° ë° ìƒˆ ë‚˜ë¬´ ì¶”ê°€
        // ì¸ë±ìŠ¤ê°€ í° ê²ƒë¶€í„° ì‚­ì œí•´ì•¼ splice ì‹œ ì¸ë±ìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ
        trees.splice(Math.max(tree1Index, tree2Index), 1);
        trees.splice(Math.min(tree1Index, tree2Index), 1);
        trees.push(newTree);

        inventory["ê²°í•©ì˜ ë¬˜ëª© ì‚½"]--;
        log("ë‘ ê·¸ë£¨ì˜ ë‚˜ë¬´ë¥¼ í•©ì³¤ìŠµë‹ˆë‹¤! ğŸŒ²", "log-success");
        renderTrees();
        updateUI();
      }

      function showPopup(title, message, options) {
        eventTitle.textContent = title;
        eventMessage.textContent = message;
        eventOptions.innerHTML = "";
        options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.textContent = opt.text;
          btn.onclick = opt.action;
          if (opt.isDanger) btn.classList.add("danger");
          if (opt.isDisabled) btn.disabled = true;
          eventOptions.appendChild(btn);
        });
        popupOverlay.style.display = "flex";
        pauseGame(); // íŒì—… ì‹œ ê²Œì„ ì¼ì‹œì •ì§€
      }

      function hidePopup() {
        popupOverlay.style.display = "none";
        resumeGame(); // íŒì—… ë‹«íˆë©´ ê²Œì„ ì¬ê°œ
        updateUI();
      }

      function pauseGame() {
        isGamePaused = true;
        if (gameInterval) {
          // gameIntervalì´ nullì´ ì•„ë‹ ë•Œë§Œ clearInterval í˜¸ì¶œ
          clearInterval(gameInterval);
          gameInterval = null; // ì¸í„°ë²Œ ID ì´ˆê¸°í™”
        }
        stopMiniGame(); // ë¯¸ë‹ˆê²Œì„ ì •ì§€ (ë„í† ë¦¬ ìƒì„± ë° ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨)
        typingInput.disabled = true; // ì…ë ¥ì°½ ë¹„í™œì„±í™”
      }

      function resumeGame() {
        if (!isGamePaused) {
          // ì´ë¯¸ ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ ë‹¤ì‹œ ì‹œì‘í•˜ì§€ ì•ŠìŒ
          return;
        }
        isGamePaused = false;

        // ë©”ì¸ ê²Œì„ íƒ€ì´ë¨¸ ì¬ì‹œì‘ (ì´ë¯¸ ê²Œì„ ì˜¤ë²„/ìŠ¹ë¦¬ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´)
        if (
          day <= 100 &&
          window.getComputedStyle(gameOverOverlay).display !== "flex"
        ) {
          // gameIntervalì´ nullì¼ ë•Œë§Œ ìƒˆë¡œ ìƒì„±í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
          if (gameInterval === null) {
            gameInterval = setInterval(() => {
              timer--;
              timerSpan.textContent = timer;
              trees.forEach((t) => t.attemptProduction());
              updateUI();

              if (timer <= 0) {
                day++;
                if (day > 100) {
                  gameWin();
                  return;
                }
                timer = 60;
                log(`=== ${day}ì¼ì°¨ ì•„ì¹¨ ===`, "log-important");
                triggerDailyEvent(); // ì´ë²¤íŠ¸ ë°œìƒ í•¨ìˆ˜ í˜¸ì¶œ (ë§¤ì¼ ë°œìƒ)
              }
            }, 1000);
          }
          startMiniGame(); // ë¯¸ë‹ˆê²Œì„ ì¬ì‹œì‘
          typingInput.disabled = false; // ì…ë ¥ì°½ í™œì„±í™”
          typingInput.focus(); // ì…ë ¥ì°½ì— ìë™ í¬ì»¤ìŠ¤
        }
      }

      function triggerDailyEvent() {
        // 'íŠ¹ë³„í•œ ì¼ ì—†ëŠ” ë‚ 'ì„ ì—†ì• ê³  ë¬´ì¡°ê±´ ì´ë²¤íŠ¸ ë°œìƒ
        const randomEvent =
          eventList[Math.floor(Math.random() * eventList.length)];
        handleEvent(randomEvent);
      }

      function handleEvent(ev) {
        log(`ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë°œìƒ: ${ev.name}!`, "log-important");
        let options = [];
        const currentCost = ev.baseCost * day; // ì¼ì°¨ì— ë”°ë¼ ë¹„ìš© ì¦ê°€
        const currentLossRate = ev.baseLossRate + day * 0.005; // ì¼ì°¨ì— ë”°ë¼ ì†ì‹¤ë¥  ì¦ê°€ (ìµœëŒ€ 0.5)

        switch (ev.type) {
          case "disaster":
            const hasDefense = inventory[ev.defenseItem] > 0;
            const canAfford = acorns >= currentCost;

            options.push({
              text: `${ev.defenseItem} ì‚¬ìš© (${inventory[ev.defenseItem]}ê°œ)`,
              action: () => {
                inventory[ev.defenseItem]--;
                log(
                  `${ev.defenseItem}ì„(ë¥¼) ì‚¬ìš©í•˜ì—¬ ${ev.name} ë°©ì–´ ì„±ê³µ! ğŸ›¡ï¸`,
                  "log-success"
                );
                hidePopup();
                offerRewardItems(ev.rewards); // ë°©ì–´ ì„±ê³µ ì‹œ ë³´ìƒ ì„ íƒ
              },
              isDisabled: !hasDefense,
            });

            options.push({
              text: `${currentCost} ë„í† ë¦¬ ì§€ë¶ˆ`,
              action: () => {
                if (acorns >= currentCost) {
                  acorns -= currentCost;
                  log(
                    `${currentCost} ë„í† ë¦¬ë¥¼ ì§€ë¶ˆí•˜ì—¬ ${ev.name}ì„(ë¥¼) ëª¨ë©´í–ˆìŠµë‹ˆë‹¤.`,
                    "log-important"
                  );
                  hidePopup();
                  offerRewardItems(ev.rewards);
                } else {
                  alert("ë„í† ë¦¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                }
              },
              isDisabled: !canAfford,
            });

            if (!hasDefense && !canAfford) {
              options.push({
                text: "ë„ë§ì¹˜ê¸° (ê²Œì„ ì˜¤ë²„)",
                action: () =>
                  gameOver(
                    `ë„í† ë¦¬ ë˜ëŠ” ë°©ì–´ ì•„ì´í…œì´ ë¶€ì¡±í•˜ì—¬ ${ev.name}ì— ë‹¹í–ˆìŠµë‹ˆë‹¤.`
                  ),
                isDanger: true,
              });
            }
            break;
          case "threat":
            const hasThreatDefense = inventory[ev.defenseItem] > 0;
            const actualLoss = Math.min(0.8, currentLossRate); // ìµœëŒ€ ì†ì‹¤ë¥  ì œí•œ
            const lostAcorns = Math.floor(acorns * actualLoss);

            options.push({
              text: `${ev.defenseItem} ì‚¬ìš© (${inventory[ev.defenseItem]}ê°œ)`,
              action: () => {
                inventory[ev.defenseItem]--;
                log(
                  `${ev.defenseItem}ì„(ë¥¼) ì‚¬ìš©í•˜ì—¬ ${ev.name}ì„(ë¥¼) ë§‰ì•˜ìŠµë‹ˆë‹¤! ğŸŒ§ï¸`,
                  "log-success"
                );
                hidePopup();
              },
              isDisabled: !hasThreatDefense,
            });

            options.push({
              text: `${lostAcorns} ë„í† ë¦¬ ì†ì‹¤ ê°ìˆ˜`,
              action: () => {
                acorns -= lostAcorns;
                log(
                  `ë„í† ë¦¬ ${Math.floor(actualLoss * 100)}%ë¥¼ ì†ì‹¤í–ˆìŠµë‹ˆë‹¤.`,
                  "log-important"
                );
                hidePopup();
              },
              // ì•„ì´í…œì´ ìˆìœ¼ë©´ ì†ì‹¤ ê°ìˆ˜ ë²„íŠ¼ ë¹„í™œì„±í™” (ì„ íƒ ê°•ì œ)
              // ì•„ì´í…œì´ ì—†ìœ¼ë©´ ì†ì‹¤ ê°ìˆ˜ ë²„íŠ¼ í™œì„±í™”
              isDisabled: hasThreatDefense,
            });

            if (!hasThreatDefense) {
              options[1].isDisabled = false; // ì•„ì´í…œ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ ì†ì‹¤ ê°ìˆ˜ í™œì„±í™”
            }
            break;
          case "opportunity":
            const requiredAcorns = ev.baseCost * (1 + day * 0.05); // ì¼ì°¨ì— ë”°ë¼ ë¹„ìš© ì¦ê°€
            const hasSpecialItem =
              inventory[ev.specialItem] >= ev.specialItemCost;

            options.push({
              text: `${ev.specialItem} ${ev.specialItemCost}ê°œ ì§€ë¶ˆ (íšë“ ê¸°íšŒ)`,
              action: () => {
                inventory[ev.specialItem] -= ev.specialItemCost;
                log(
                  `${ev.specialItem}ì„(ë¥¼) ì§€ë¶ˆí•˜ê³  ${ev.name}ê³¼(ì™€) ê±°ë˜í–ˆìŠµë‹ˆë‹¤.`,
                  "log-success"
                );
                hidePopup();
                offerRewardItems(ev.rewards);
              },
              isDisabled: !hasSpecialItem,
            });

            options.push({
              text: `${Math.floor(requiredAcorns)} ë„í† ë¦¬ ì§€ë¶ˆ (íšë“ ê¸°íšŒ)`,
              action: () => {
                if (acorns >= requiredAcorns) {
                  acorns -= requiredAcorns;
                  log(
                    `${Math.floor(requiredAcorns)} ë„í† ë¦¬ë¥¼ ì§€ë¶ˆí•˜ê³  ${
                      ev.name
                    }ê³¼(ì™€) ê±°ë˜í–ˆìŠµë‹ˆë‹¤.`,
                    "log-success"
                  );
                  hidePopup();
                  offerRewardItems(ev.rewards);
                } else {
                  alert("ë„í† ë¦¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                }
              },
              isDisabled: acorns < requiredAcorns,
            });

            options.push({
              text: "ê±°ë˜ ê±°ë¶€ (ì•„ë¬´ ì¼ ì—†ìŒ)",
              action: () => {
                log(`${ev.name}ê³¼ì˜ ê±°ë˜ë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.`, "log-important");
                hidePopup();
              },
            });
            break;
          case "bonus":
            // ìˆ² ì¶•ì œëŠ” ì„ íƒì§€ê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë°”ë¡œ ì ìš©í•˜ê³  íŒì—… ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€
            applyFestival();
            options.push({
              text: "í™•ì¸",
              action: () => {
                hidePopup(); // íŒì—… ë‹«ê¸°
              },
            });
            break;
        }

        showPopup(`${ev.name} ğŸ””`, ev.message, options);
        updateUI();
      }

      function offerRewardItems(possibleRewards) {
        let rewardsToOffer = [];
        let tempPossibleRewards = [...possibleRewards]; // ì›ë³¸ ë°°ì—´ ë³µì‚¬

        // ë§ˆë…€ì˜ ê±°ë˜ íŠ¹ë³„ ì²˜ë¦¬: ëª¨ë“  ë°©ì–´ ì•„ì´í…œ ì¤‘ 1ê°œ
        if (tempPossibleRewards.includes("ëª¨ë“  ë°©ì–´ ì•„ì´í…œ ì¤‘ 1ê°œ")) {
          const defenseItems = [
            "ë©§ë¼ì§€ í‡´ì¹˜ìš© í˜¸ë£¨ë¼ê¸°",
            "í•˜ëŠ˜ì˜ ë°©íŒ¨ ê·¸ë¬¼",
            "ë°˜ì§ì´ëŠ” í—ˆìˆ˜ì•„ë¹„",
            "ë±€ ë¬¼ë¦¬ì¹˜ëŠ” í’€",
            "íŠ¼íŠ¼í•œ ë°©ìˆ˜í¬",
          ];
          const randomDefenseItem =
            defenseItems[Math.floor(Math.random() * defenseItems.length)];
          rewardsToOffer.push(randomDefenseItem);
          // ë‚˜ë¨¸ì§€ ë³´ìƒ ëª©ë¡ì—ì„œ "ëª¨ë“  ë°©ì–´ ì•„ì´í…œ ì¤‘ 1ê°œ" ì œê±°
          tempPossibleRewards = tempPossibleRewards.filter(
            (item) => item !== "ëª¨ë“  ë°©ì–´ ì•„ì´í…œ ì¤‘ 1ê°œ"
          );
        }

        // ë‚˜ë¨¸ì§€ ë³´ìƒ ì•„ì´í…œ ëœë¤ ì„ íƒ (ì´ 3ê°œê°€ ë˜ë„ë¡)
        while (rewardsToOffer.length < 3 && tempPossibleRewards.length > 0) {
          const randomIndex = Math.floor(
            Math.random() * tempPossibleRewards.length
          );
          const item = tempPossibleRewards[randomIndex];
          rewardsToOffer.push(item);
          tempPossibleRewards.splice(randomIndex, 1); // ì¤‘ë³µ ë°©ì§€
        }

        eventTitle.textContent = "ë³´ìƒ ì„ íƒ ğŸ";
        eventMessage.textContent = "ì›í•˜ëŠ” ì•„ì´í…œ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!";
        eventOptions.innerHTML = "";

        rewardsToOffer.forEach((item) => {
          const btn = document.createElement("button");
          btn.textContent = item;
          btn.onclick = () => {
            if (inventory[item] !== undefined) {
              inventory[item]++;
              log(`${item}ì„(ë¥¼) íšë“í–ˆìŠµë‹ˆë‹¤!`, "log-success");
            } else {
              log(`ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ: ${item}`, "log-important");
            }
            hidePopup();
          };
          eventOptions.appendChild(btn);
        });
        popupOverlay.style.display = "flex";
      }

      function applyFestival() {
        if (festivalActive) return;
        festivalActive = true;
        log(
          "ìˆ² ì¶•ì œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ëª¨ë“  ë‚˜ë¬´ ìƒì‚°ëŸ‰ì´ 2ë°°! ğŸ‰",
          "log-success"
        );
        // ì‹¤ì œ ìƒì‚°ëŸ‰ì€ attemptProductionì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ 2ë°° ì ìš©
        setTimeout(() => {
          festivalActive = false;
          log("ìˆ² ì¶•ì œê°€ ëë‚¬ìŠµë‹ˆë‹¤.", "log-important");
          trees.forEach((t) => t.updateDisplay()); // í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
        }, 1000 * 60); // 1ë¶„ê°„ ì§€ì† (ê²Œì„ ì‹œê°„ 60ì´ˆ)
      }

      function gameOver(message) {
        pauseGame(); // ê²Œì„ ì˜¤ë²„ ì‹œ ê²Œì„ ì •ì§€
        gameOverMessage.textContent = message;
        gameOverOverlay.style.display = "flex";
        log(message, "log-important");
      }

      function gameWin() {
        pauseGame(); // ê²Œì„ ìŠ¹ë¦¬ ì‹œ ê²Œì„ ì •ì§€
        gameOverOverlay.style.display = "flex";
        gameOverPopup.querySelector("h3").textContent = "ìŠ¹ë¦¬! ğŸ†";
        gameOverPopup.querySelector("h3").style.color = "#4CAF50";
        gameOverMessage.textContent = `ì¶•í•˜í•©ë‹ˆë‹¤! 100ì¼ ë™ì•ˆ ë„í† ë¦¬ ëª©ì¥ì„ ì„±ê³µì ìœ¼ë¡œ ìš´ì˜í–ˆìŠµë‹ˆë‹¤! ë‹¹ì‹ ì€ ìµœê³ ì˜ ë‹¤ëŒì¥ ì¡±ì¥ì…ë‹ˆë‹¤!`;
        log("100ì¼ ìƒì¡´ ì„±ê³µ! ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ¥³", "log-success");
      }

      // ë¯¸ë‹ˆê²Œì„ ë¡œì§ ì‹œì‘
      function createFallingAcorn() {
        const word =
          typingWords[Math.floor(Math.random() * typingWords.length)];
        const acorn = document.createElement("div");
        acorn.classList.add("falling-acorn");
        acorn.textContent = word;
        acorn.dataset.word = word; // ë„í† ë¦¬ì˜ ë‹¨ì–´ë¥¼ ë°ì´í„°ì…‹ì— ì €ì¥

        const gameAreaWidth = miniGameArea.offsetWidth;
        const startX = Math.random() * (gameAreaWidth - 60); // 60pxëŠ” ë„í† ë¦¬ ë„ˆë¹„
        acorn.style.left = `${startX}px`;
        acorn.style.top = `-60px`; // í™”ë©´ ìƒë‹¨ ë°–ì—ì„œ ì‹œì‘

        miniGameArea.appendChild(acorn);
        fallingAcorns.push({
          element: acorn,
          word: word,
          top: -60,
          speed: 1 + Math.random() * 1.5,
        }); // ì†ë„ ëœë¤í™”
      }

      function animateFallingAcorns() {
        if (isGamePaused) {
          // ê²Œì„ì´ ì¼ì‹œì •ì§€ ìƒíƒœë©´ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ë‹¨
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null; // ID ì´ˆê¸°í™”
          return;
        }

        for (let i = fallingAcorns.length - 1; i >= 0; i--) {
          const acorn = fallingAcorns[i];
          acorn.top += acorn.speed;
          acorn.element.style.top = `${acorn.top}px`;

          if (acorn.top > miniGameArea.offsetHeight) {
            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
            acorn.element.remove();
            fallingAcorns.splice(i, 1);
          }
        }
        animationFrameId = requestAnimationFrame(animateFallingAcorns);
      }

      function startMiniGame() {
        if (miniGameAcornInterval) clearInterval(miniGameAcornInterval); // ê¸°ì¡´ ì¸í„°ë²Œ í´ë¦¬ì–´
        miniGameAcornInterval = setInterval(
          createFallingAcorn,
          1500 + Math.random() * 1000
        ); // 1.5~2.5ì´ˆë§ˆë‹¤ ìƒì„±
        if (animationFrameId === null) {
          // ì• ë‹ˆë©”ì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì‹œì‘
          animationFrameId = requestAnimationFrame(animateFallingAcorns); // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        }
        typingInput.disabled = false; // ì…ë ¥ì°½ í™œì„±í™”
        typingInput.focus(); // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
      }

      function stopMiniGame() {
        if (miniGameAcornInterval) clearInterval(miniGameAcornInterval);
        miniGameAcornInterval = null;
        if (animationFrameId) cancelAnimationFrame(animationFrameId); // requestAnimationFrame ì¤‘ë‹¨
        animationFrameId = null; // ID ì´ˆê¸°í™”
        // ëª¨ë“  ë–¨ì–´ì§€ëŠ” ë„í† ë¦¬ ì œê±°
        fallingAcorns.forEach((acorn) => acorn.element.remove());
        fallingAcorns = [];
        typingInput.value = ""; // ì…ë ¥ì°½ ë¹„ì›€
        typingInput.disabled = true; // ì…ë ¥ì°½ ë¹„í™œì„±í™”
      }

      // íƒ€ì ì…ë ¥ ì²˜ë¦¬
      typingInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          if (isGamePaused) return; // ê²Œì„ ì¼ì‹œì •ì§€ ì¤‘ì—ëŠ” ì…ë ¥ ë¬´ì‹œ

          const typedWord = typingInput.value.trim();
          let found = false;

          for (let i = fallingAcorns.length - 1; i >= 0; i--) {
            const acorn = fallingAcorns[i];
            if (acorn.word === typedWord) {
              acorns += 1;
              log(`'${typedWord}' ë„í† ë¦¬ 1ê°œ íšë“! ğŸŒ°`, "log-success");
              updateUI();

              // ë„í† ë¦¬ê°€ ì‚¬ë¼ì§€ëŠ” ì‹œê°ì  íš¨ê³¼
              acorn.element.classList.add("hit");
              setTimeout(() => {
                acorn.element.remove();
              }, 200); // 0.2ì´ˆ í›„ ì‹¤ì œ ì œê±°

              fallingAcorns.splice(i, 1);
              found = true;
              break; // í•œ ë²ˆì— í•˜ë‚˜ì˜ ë„í† ë¦¬ë§Œ ì¡ê¸°
            }
          }

          if (!found) {
            log(
              `'${typedWord}' ë‹¨ì–´ì™€ ì¼ì¹˜í•˜ëŠ” ë„í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.`,
              "log-important"
            );
          }
          typingInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        }
      });
      // ë¯¸ë‹ˆê²Œì„ ë¡œì§ ë

      function initializeGame() {
        day = 1;
        acorns = 0;
        timer = 60;
        trees = [];
        festivalActive = false;
        probabilityUpgradeCount = 0;
        isGamePaused = true; // ê²Œì„ ì‹œì‘ ë²„íŠ¼ ëˆ„ë¥´ê¸° ì „ê¹Œì§€ëŠ” ì¼ì‹œì •ì§€ ìƒíƒœ

        // ëª¨ë“  ì¸í„°ë²Œ/ì• ë‹ˆë©”ì´ì…˜ ìš”ì²­ ì´ˆê¸°í™”
        if (gameInterval) clearInterval(gameInterval);
        gameInterval = null;
        if (miniGameAcornInterval) clearInterval(miniGameAcornInterval);
        miniGameAcornInterval = null;
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        fallingAcorns = [];

        for (const key in inventory) {
          inventory[key] = 0;
        }
      }

      // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      startButton.addEventListener("click", () => {
        startScreen.style.display = "none"; // ì‹œì‘ í™”ë©´ ìˆ¨ê¹€
        gameContainer.style.display = "block"; // ê²Œì„ í™”ë©´ í‘œì‹œ

        // ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
        initializeGame(); // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
        plantNewTree(); // ì²« ë‚˜ë¬´ ì‹¬ê¸°
        updateUI();
        log("ê²Œì„ ì‹œì‘! ğŸŒ°", "log-important");
        resumeGame(); // ê²Œì„ ì‹œì‘
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì„ ì´ˆê¸° ìƒíƒœ ì„¤ì • (ì‹œì‘ í™”ë©´ë§Œ ë³´ì„)
      initializeGame(); // ì´ í•¨ìˆ˜ëŠ” ê²Œì„ì´ ë¡œë“œë  ë•Œ í•œ ë²ˆ í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    </script>
  </body>
</html>
